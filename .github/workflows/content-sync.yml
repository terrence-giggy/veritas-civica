# Content Sync Workflow
# Retrieves content from GitHub Discussions and creates a PR with changes
#
# Triggers:
# - Manual: workflow_dispatch with optional source/topic selection
# - Scheduled: Daily at 6:00 AM UTC
#
# Required Secrets:
# - CONTENT_SYNC_TOKEN: GitHub PAT with repo scope for reading discussions
#   (Uses default GITHUB_TOKEN for creating PRs)
#
# Note: Creates a pull request instead of pushing directly to main
# to comply with branch protection rules.

name: Sync Content

on:
  workflow_dispatch:
    inputs:
      source:
        description: 'Source to sync (leave empty for all)'
        required: false
        default: ''
        type: string
      topic:
        description: 'Topic to sync (People, Organizations, or empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - People
          - Organizations
      dry_run:
        description: 'Dry run (preview changes without committing)'
        required: false
        default: false
        type: boolean

  # schedule:
  #   - cron: '0 6 * * *'

permissions:
  contents: write
  pull-requests: write

env:
  NODE_VERSION: '20'

jobs:
  sync:
    name: Sync Content
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run content sync
        id: sync
        env:
          GITHUB_TOKEN: ${{ secrets.CONTENT_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.CONTENT_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          npx tsx pipeline/cli.ts ci-sync \
            ${{ inputs.source && format('--source {0}', inputs.source) || '' }} \
            ${{ inputs.topic && format('--topic {0}', inputs.topic) || '' }} \
            ${{ inputs.dry_run == true && '--dry-run' || '' }} \
            --verbose

      - name: Create Pull Request
        if: steps.sync.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.CONTENT_SYNC_TOKEN || secrets.GITHUB_TOKEN }}
          commit-message: ${{ steps.sync.outputs.commit_message }}
          branch: ${{ steps.sync.outputs.pr_branch }}
          delete-branch: true
          title: ${{ steps.sync.outputs.pr_title }}
          body: ${{ steps.sync.outputs.pr_body }}
          labels: ${{ steps.sync.outputs.pr_labels }}
